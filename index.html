<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bounded Spiral Designer</title>
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    :root{--bg:#0d0d0d;--surface:#161616;--accent:#0a84ff;--text:#eaeaea;--muted:#888;--grid:#222}
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:var(--bg);color:var(--text)}
    header{padding:1.2rem 2rem;font-size:1.4rem;font-weight:600}
    main{flex:1;display:grid;grid-template-rows:1fr auto}
    #graph{width:100%;height:100%}
    #controls{background:var(--surface);padding:1rem 2rem;border-top:1px solid #222;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem 2rem}
    .control{display:flex;flex-direction:column;gap:.35rem}
    label{font-size:.9rem;font-weight:500;color:var(--muted)}
    input[type=range],input[type=text],input[type=number]{width:100%;}
    input[type=range]{-webkit-appearance:none;height:6px;border-radius:3px;background:#333}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer}
    input[type=text],input[type=number]{padding:.45rem .6rem;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:var(--text)}
    .value-label{align-self:flex-end;font-size:.85rem}
    .param-display{font-size:.75rem;color:var(--muted);margin-top:.2rem}
    button{padding:.55rem 1.1rem;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:.85rem}
    button:disabled{background:#666;cursor:not-allowed}
    #btnRow{grid-column:1/-1;display:flex;gap:1rem;justify-content:center}
    .status{font-size:.8rem;color:var(--muted);text-align:center;margin-top:0.5rem}
    .error{color:#ff6b6b}
    .success{color:#51cf66}
  </style>
</head>
<body>
  <header>Bounded Spiral Designer</header>
  <main>
    <section id="graph"></section>
    <section id="controls">
      <div class="control">
        <label>Batteries (minimum 2)</label>
        <input id="batteries" type="number" min="2" max="10" value="2">
        <span class="value-label" id="batteryVal">2 batteries</span>
      </div>
      <div class="control">
        <label>Size</label>
        <input id="size" type="range" min="0" max="100" value="0">
        <span class="value-label" id="sizeVal">Small</span>
        <div class="param-display" id="paramDisplay">
          Start: 150ft • Hold: 500ft • Bounces: 5
        </div>
      </div>
      <div class="control">
        <label>Minimum Height (ft AGL)</label>
        <input id="minHeight" type="number" min="50" max="1000" value="100" step="10">
        <span class="value-label" id="minHeightVal">100 ft</span>
      </div>
      <div class="control">
        <label>Maximum Height (ft AGL)</label>
        <input id="maxHeight" type="number" min="100" max="2000" value="400" step="10">
        <span class="value-label" id="maxHeightVal">400 ft</span>
      </div>
      <div class="control" style="grid-column:1/-1">
        <label>Center (lat, lon)</label>
        <input id="centerLL" type="text" placeholder="41.73218° N, 111.83979° W  or  41.73218, -111.83979">
        <div class="param-display" id="elevationDisplay" style="margin-top: 0.3rem; color: var(--muted);">
          Enter coordinates to see ground elevation
        </div>
      </div>
      <div id="btnRow">
        <div id="batteryButtons" style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;"></div>
        <button id="csvMasterBtn" style="margin-top: 0.5rem;">Download Master CSV</button>
      </div>
      <div class="status" id="status">Ready</div>
    </section>
  </main>

<script>
(()=>{
  // Configuration
  const API_BASE = 'http://localhost:5001/api';
  
  // DOM elements
  const $=id=>document.getElementById(id);
  const batteriesS=$('batteries'), sizeS=$('size'), minHeightS=$('minHeight'), maxHeightS=$('maxHeight');
  const lbl={batteryVal:$('batteryVal'),sizeVal:$('sizeVal'),minHeightVal:$('minHeightVal'),maxHeightVal:$('maxHeightVal')};
  const statusEl = $('status');
  const paramDisplay = $('paramDisplay');
  
  // Event listeners for controls
  [batteriesS, sizeS, minHeightS, maxHeightS].forEach(el=>el.addEventListener('input',()=>refresh()));
  $('csvMasterBtn').addEventListener('click', downloadCSV);
  $('centerLL').addEventListener('blur', checkElevation);

  // Utility functions
  const setStatus = (msg, type = 'info') => {
    statusEl.textContent = msg;
    statusEl.className = `status ${type}`;
  };
  
  const setButtonsEnabled = (enabled) => {
    $('csvMasterBtn').disabled = !enabled;
    
    // Also disable/enable all battery buttons
    const batteryButtons = document.querySelectorAll('.battery-btn');
    batteryButtons.forEach(btn => btn.disabled = !enabled);
  };

  // Validate and get height values
  const getHeightValues = () => {
    let minHeight = parseInt(minHeightS.value) || 100;
    let maxHeight = parseInt(maxHeightS.value) || 400;
    
    // Ensure min is not greater than max
    if (minHeight >= maxHeight) {
      maxHeight = minHeight + 50;
      maxHeightS.value = maxHeight;
    }
    
    return { minHeight, maxHeight };
  };

  // Validate and get battery count
  const getBatteryCount = () => {
    let batteries = parseInt(batteriesS.value);
    if (isNaN(batteries) || batteries < 2) {
      batteries = 2;
      batteriesS.value = 2;
    }
    if (batteries > 10) {
      batteries = 10;
      batteriesS.value = 10;
    }
    return batteries;
  };

  // Calculate individual parameters from size slider
  const calculateParams = (sizeValue) => {
    const size = parseFloat(sizeValue);
    const batteries = getBatteryCount();
    const heights = getHeightValues();
    
    // Linear interpolation for each parameter
    const r0 = 150 + (size / 100) * (500 - 150);      // 150ft → 500ft
    const rHold = 500 + (size / 100) * (3000 - 500);  // 500ft → 3000ft
    const N = Math.round(5 + (size / 100) * (10 - 5)); // 5 → 10 bounces
    
    return {
      slices: batteries,  // batteries = slices for the backend
      N: N,
      r0: Math.round(r0 * 10) / 10,  // Round to 1 decimal
      rHold: Math.round(rHold),        // Round to nearest integer
      minHeight: heights.minHeight,
      maxHeight: heights.maxHeight
    };
  };

  const params = () => calculateParams(sizeS.value);
  
  const updateLabels = () => {
    const batteries = getBatteryCount();
    lbl.batteryVal.textContent = `${batteries} ${batteries === 1 ? 'battery' : 'batteries'}`;
    
    const size = parseInt(sizeS.value);
    let sizeLabel;
    if (size <= 20) sizeLabel = 'Small';
    else if (size <= 40) sizeLabel = 'Medium-Small';
    else if (size <= 60) sizeLabel = 'Medium';
    else if (size <= 80) sizeLabel = 'Medium-Large';
    else sizeLabel = 'Large';
    
    lbl.sizeVal.textContent = sizeLabel;
    
    // Update height labels
    const heights = getHeightValues();
    lbl.minHeightVal.textContent = `${heights.minHeight} ft`;
    lbl.maxHeightVal.textContent = `${heights.maxHeight} ft`;
    
    // Update parameter display
    const p = calculateParams(size);
    paramDisplay.textContent = `Start: ${p.r0}ft • Hold: ${p.rHold}ft • Bounces: ${p.N}`;
  };

  // API functions
  async function apiCall(endpoint, data = null, options = {}) {
    try {
      const config = {
        method: data ? 'POST' : 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        ...options
      };
      
      if (data) {
        config.body = JSON.stringify(data);
      }
      
      const response = await fetch(`${API_BASE}${endpoint}`, config);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }
      
      return response;
    } catch (error) {
      console.error(`API call failed: ${endpoint}`, error);
      setStatus(`Error: ${error.message}`, 'error');
      throw error;
    }
  }

  async function getSpiralData() {
    try {
      setStatus('Generating spiral...');
      const response = await apiCall('/spiral-data', params());
      const data = await response.json();
      return data;
    } catch (error) {
      setStatus('Failed to generate spiral', 'error');
      throw error;
    }
  }

  async function downloadCSV() {
    try {
      const centerVal = $('centerLL').value.trim();
      if (!centerVal) {
        alert('Please enter center coordinates');
        return;
      }
      
      setStatus('Generating CSV...');
      setButtonsEnabled(false);
      
      const requestData = {
        ...params(),
        center: centerVal
      };
      
      const response = await apiCall('/csv', requestData);
      
      // Create blob and download
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'litchi_spiral_mission.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      setStatus('CSV downloaded successfully', 'success');
    } catch (error) {
      setStatus('Failed to generate CSV', 'error');
    } finally {
      setButtonsEnabled(true);
    }
  }

  // Create battery download buttons
  const createBatteryButtons = () => {
    const batteries = getBatteryCount();
    const batteryButtonsContainer = $('batteryButtons');
    
    // Clear existing buttons
    batteryButtonsContainer.innerHTML = '';
    
    // Create individual battery buttons
    for (let i = 1; i <= batteries; i++) {
      const btn = document.createElement('button');
      btn.textContent = `Battery ${i}`;
      btn.className = 'battery-btn';
      btn.style.cssText = 'padding: 0.4rem 0.8rem; font-size: 0.8rem; background: #444; border: 1px solid #666;';
      btn.addEventListener('click', () => downloadBatteryCSV(i));
      batteryButtonsContainer.appendChild(btn);
    }
  };

  async function downloadBatteryCSV(batteryNumber) {
    try {
      const centerVal = $('centerLL').value.trim();
      if (!centerVal) {
        alert('Please enter center coordinates');
        return;
      }
      
      setStatus(`Generating Battery ${batteryNumber} CSV...`);
      setButtonsEnabled(false);
      
      const requestData = {
        ...params(),
        center: centerVal
      };
      
      const response = await apiCall(`/csv/battery/${batteryNumber}`, requestData);
      
      // Create blob and download
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `litchi_spiral_battery_${batteryNumber}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      setStatus(`Battery ${batteryNumber} CSV downloaded successfully`, 'success');
    } catch (error) {
      setStatus(`Failed to generate Battery ${batteryNumber} CSV`, 'error');
    } finally {
      setButtonsEnabled(true);
    }
  }

  async function draw() {
    try {
      const spiralData = await getSpiralData();
      const traces = spiralData.traces || [];
      
      Plotly.newPlot('graph', traces, {
        margin: {t: 20, l: 20, r: 20, b: 20},
        paper_bgcolor: 'var(--bg)',
        plot_bgcolor: 'var(--bg)',
        showlegend: false,
        xaxis: {
          showgrid: true,
          gridcolor: 'var(--grid)',
          dtick: 2,
          showticklabels: false,
          zeroline: false,
          scaleanchor: 'y',
          scaleratio: 1
        },
        yaxis: {
          showgrid: true,
          gridcolor: 'var(--grid)',
          dtick: 2,
          showticklabels: false,
          zeroline: false
        }
      });
      
      setStatus('Ready');
    } catch (error) {
      console.error('Draw error:', error);
      setStatus('Failed to draw spiral', 'error');
    }
  }

  async function refresh() {
    updateLabels();
    createBatteryButtons();
    await draw();
  }

  // Health check on startup
  async function checkHealth() {
    try {
      const response = await fetch(`${API_BASE}/health`);
      if (response.ok) {
        setStatus('Connected to Python backend', 'success');
        setTimeout(() => setStatus('Ready'), 2000);
      } else {
        throw new Error('Backend not responding');
      }
    } catch (error) {
      setStatus('Backend connection failed - Please start Python server', 'error');
    }
  }

  // Check elevation for entered coordinates
  async function checkElevation() {
    const centerVal = $('centerLL').value.trim();
    const elevationDisplay = $('elevationDisplay');
    
    if (!centerVal) {
      elevationDisplay.textContent = 'Enter coordinates to see ground elevation';
      return;
    }
    
    try {
      elevationDisplay.textContent = 'Checking elevation...';
      const response = await apiCall('/elevation', { center: centerVal });
      const data = await response.json();
      
      elevationDisplay.textContent = `Ground elevation: ${data.elevation_feet} ft (${data.elevation_meters} m)`;
    } catch (error) {
      elevationDisplay.textContent = 'Unable to get elevation data';
    }
  }

  // Initialize
  updateLabels();
  createBatteryButtons();
  checkHealth();
  refresh();
})();
</script>
</body>
</html>
